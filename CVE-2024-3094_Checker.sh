#!/bin/bash
echo "Detect and Remediate CVE-2024-3094"
echo "Author: https://github.com/hazemkya"
echo "CISA Alert: https://www.cisa.gov/news-events/alerts/2024/03/29/reported-supply-chain-compromise-affecting-xz-utils-data-compression-library-cve-2024-3094"
echo 

set -eu

REMEDIATE="false"
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m' 
YELLOW='\033[1;33m'

if command -v apt > /dev/null; then
    PACKAGE_MANAGER="apt"
elif command -v yum > /dev/null; then
    PACKAGE_MANAGER="yum"
elif command -v dnf > /dev/null; then
    PACKAGE_MANAGER="dnf"
else
    echo -e "Your package manager is not supported."
    exit 1
fi

if [ "$#" -eq 0 ]; then
    echo -e "${YELLOW}Running in detection mode: Use -r to remediate the vulnerability by installing xz-utils 5.2.4${NC}"
elif [ "$1" == "-r" ]; then
    REMEDIATE="true"
    echo -e "${GREEN}Running in remediation mode${NC}"
fi

reinstall_xz() {
    if [ "$PACKAGE_MANAGER" == "apt" ]; then
        sudo apt remove -y xz-utils
        sudo apt update
        sudo apt install -y xz-utils=5.2*
    elif [ "$PACKAGE_MANAGER" == "dnf" ]; then
        sudo dnf remove -y xz
        sudo dnf install -y xz-5.2.4-4.el8_6
    elif [ "$PACKAGE_MANAGER" == "yum" ]; then
        sudo yum remove -y xz
        sudo yum install -y xz-5.2.4-4.el8_6 
    fi
    
    echo -e "${GREEN}xz-utils $(xz --version | grep -oP '\K[0-9]+\.[0-9]+\.[0-9]+' | head -n1) has been installed successfully.${NC}"
}


XZ_VERSION=$(xz --version | grep -oP '\K[0-9]+\.[0-9]+\.[0-9]+' | head -n1)

if [[ "$XZ_VERSION" == "5.6.0" || "$XZ_VERSION" == "5.6.1" ]]; then
    echo -e "${RED}Detected compromised xz-utils version $XZ_VERSION.${NC}"
    if [ "$REMEDIATE" == "true" ]; then
        echo "Replacing xz-utils with version 5.2.4..."
        echo "This will only prevent the vulnerability from being exploited, not remove any backdoors that may have been installed."
        reinstall_xz
    fi
else
    echo -e "${GREEN}xz-utils version $XZ_VERSION is not vulnerable, no action needed.${NC}"
fi

# find path to liblzma used by sshd
path="$(ldd $(which sshd) | grep liblzma | grep -o '/[^ ]*')"

# does it even exist?
if [ "$path" == "" ]; then
    echo -e "${YELLOW}Path to liblzma not found${NC}"
elif hexdump -ve '1/1 "%.2x"' "$path" | grep -q f30f1efa554889f54c89ce5389fb81e7000000804883ec28488954241848894c2410; then
    echo -e "${RED}liblzma used by sshd probably vulnerable${NC}"
else
    echo -e "liblzma used by sshd probably not vulnerable"
fi